命令模式进入编辑模式：`i`。

编辑模式回到命令模式： esc。

进入编辑模式还有许多方法，比如a、s、o等字母，但是都可以用i+其它操作组合，所以只要记住一个i就行。

本文目的不是成为vim专家，而是为了能够满足工作。

另外，在命令模式下，不要乱敲键盘，防止是一个不熟悉的命令，触发后又撤销不了就麻烦了。

下文所有命令都是在命令模式下，除非特殊说明。

## 退出vi操作

首先说明，vi里面输入命令，要先输入`:`。有些书上把输入`:`后的状态称为`末行模式`。结合命令行模式、文本输入模式，即vi一共有三种工作模式。我们这里把末行模式和命令行模式合起来，统称命令模式。

输入`:`后，窗口的最下面出现类似控制台的一行命令输入区域，然后在":"后面输入命令。即vi的所有命令都是先敲”:“冒号。

先esc回到命令模式，然后

1. :q 退出vi
2. :w 保存
3. :wq 保存退出
4. :q! 不保存退出

## 光标移动

首先，键盘右边那块（insert 、 delete 、HOME、END、箭头、小键盘数字等），vi都是能用的，含义与正常理解的相同，比如箭头移动光标，HOME到行首等。但是，vi大多提供了用键盘主区域的字母代替这些符号，如hjkl表示箭头左下上右的功能。处于简单易学的目的，这些不掌握，用小键盘即可。但文中可能会提一下。

###  行移动

1. 箭头上下左右
2. 直接回车，下移一行
3. 数字+回车，下移n行。在新打开的文件，光标在行首，这时输入数字n，回车，相当于定位到n+1行。
4. 先输一个数字，然后按箭头。比如按下（5+上箭头），则光标上移5行，相当于连续按5次向上箭头。

（键盘上一些字母等同箭头，hjkl表示左下上右）

### 翻页

Page Up 或 ctrl-b: 上翻一页（back,往回，就是向上）  
Page Down 或 ctrl-f：下翻一页（forward ,往回，就是向上）   
Page Up/Down更好记，但是有时在shell里用vi打开文档，PageUp是shell窗口的滚动条翻页，这时就只能用ctrl+b/f了。

G: 移动到文档最后一行  
gg: 移动到文档第一行  

3gg:移动到文档第3行 

3G: 移动到第3行  

:3回车  移动到第3行  

（也就是说，ngg = nG = :n回车）

HML: 分别移到到当前窗口可视区域的首中末

**(这一节我觉得只要记住Page Up、Page Down、:n回车三个。跳到第一行用:1代替gg；跳到最后一行可以先ctrl+G查看文档信息知道一共多少行，再“:行号”回车,或者一般文件不会太大，按住Page Down不动很快就到末尾了)**

## 查找和替换

1. /xxx  从上往下开始查找
2. ?xxx  从下往上开始查找

按下回车，然后，

n：下一个匹配（next的首字母）

N: 上一个匹配



替换的命令比较复杂。总的格式为：

```less
:[addr]s/源字符串/目标字符串/[option]
```

全局替换：

```ruby
:%s/源字符串/目标字符串/g
```

分情况举例说明。

1. 先把光标移到某一行，然后用命令**`:s/old/new/`**，将当前行的**第一个**old字符串替换成new。
2. 命令**`:s/old/new/g`**，将当前行的**所有**old字符串替换成new。
3. 命令**`:n,ms/old/new/ `** 从第 n 行到第m行，每一行的**第一个** old替换为new。比如，“:2,3s/aaa/bbb/”，把2、3两行的第一个aaa替换成bbb。
4. 命令**`:n,ms/old/new/g `** 从第 n 行到第m行，每一行的所有 old替换为new。
5. 命令**`:n,$s/old/new/ `** 从第 n 行到最后一行，每一行的**第一个** old替换为new。
6. 命令**`:n,$s/old/new/g `** 从第 n 行到最后一行，每一行的**所有** old替换为new。
7. 命令**`:.,$s/old/new/g `** 从当前行到最后一行，每一行的**所有** old替换为new。点号可省略，命令为：**`:,$s/old/new/g `** 
8. 命令**`:$s/old/new/g `** 把最后一行的**所有** old替换为new。
9. 命令**`:%s/old/new/g `**  整个文件搜索替换。把末尾g去掉，则表示整个文件替换每一行的第一个。

总结一下就是：

1） $表示最后一行（你可能会猜^是不是表示第一行。但很可惜不支持^）  

2） 数字n表示第n行

3） :n,ms中，n应该比m小。

4)   .号表示当前光标所在行

5） 末尾加g，表示替换一行之内的所有匹配

5） "%"：表示整个文件，同"1,$"。

下文[**set命令**](#set命令)这一节介绍到，CR符号在vi里面显示为^M。那么这种特殊符号怎么匹配呢？下面这个命令把当前行的CR符号替换成字母T :

```ruby
:s/\r/T/  或者
:s/^M/T/
```

但是这里的^M不是字母输入的，而是“ctrl+v ctrl+m”组合键输入。我们只记住用“\r”转义字符即可。

## 撤销、重复

u: 撤销，相当于windows的Ctrl+z

Ctrl+r： 恢复撤销，相当于windows的Ctrl+y。

假想有一张线性表记录操作，u就是向前移动，Ctrl+r就是向后。

.  :  重复前一个动作,这个也不要记，因为可以把前一个动作再敲一遍，而不是用“.”。

## 复制、粘贴、剪切、删除

首先说明,对于通过ssh远程连接，在shell里面通过vi打开问题，vi复制的内容和外界(客户端)是不相通的。比如，我在外界复制一个‘a’, vi里面用vi专用命令复制了一个‘b’,然后外面ctrl+v粘贴的还是‘a’，而shell里面vi窗口里面，分情况：

1. 命令模式，用vi粘贴命令p，粘贴是‘b’, 二者互不干扰。
2. 编辑模式，用操作系统粘贴命令(一般是ctrl+v或者shift+insert)，粘贴的是‘a‘

究其原因，大概ctrl+c或者ctrl+insert复制内容，剪贴板在客户端windows上面，而通过vi命令模式复制的，剪贴板使用的远程linux的。

通常我们可以用鼠标选中一块，然后右键-复制，然后进入编辑模式，粘贴。但是当不能这样做时，就需要以下的vi命令。

下面介绍命令。先把vi切换到命令模式。

**复制的命令是y**，即yank（提起）。复制相关命令都是y开头。

1. `yy`，复制光标所在的整行。nyy复制多行。

2. y^  复制当前到行头的内容； 

   y$  复制当前到行尾的内容； 

   这里联想一下正则表达式，^匹配输入字符串的开始，$匹配字符串的结束。

3. y命令。首先输入v, 进入`v`模式，即可视模式, 然后光标移动时，就能看到有一些文本被高亮显示了，它们就是被选中的内容。（注意不是鼠标按住左键选中，而是通过光标移动来选中）

   然后输入一个y，即将选中部分复制到缓冲区,同时离开可视模式。



**删除、剪切的命令是d**，删除的同时会复制到缓冲区，即剪切。

1. 键盘“Delete”按键，删除当前光标字符，并复制这个字符到缓冲区。
2. 先进入可视模式，光标选中一个块，按下d，则剪切这个块。
3. dd，删除光标所在行，同时复制这个行。可以ndd剪切多行

y和d的命令大多相似，只是复制和剪切的区别，下面列出一些相似的命令：

y				  与      		  d

yy				与        		 dd

y^				与         		 d^

y$				与           		d$

yw				 与          		dw

yG				 与          		dG

前面“翻页”这一节讲过，G是移动到文档最后一行。所以这里yG意思是复制到文档末尾。

其它命令就不要记了，借助可视模式选中都可以替代。



**粘贴命令是p**，即put（放下）。在光标处粘贴复制的内容。

快速交换上下两行：ddp。其实分了两步：dd是剪切这一行，然后光标自然到了下一行，然后p是粘贴到下面一行。

## set命令

1. :set number 显示行号

2. :set nonu  取消显示行号

3. :set fileformat=unix   将MS-DOS格式的文件，转换为UNIX格式的文件。有时我们在windows上面写的代码，通过ftp上传到服务器编译，往往编译报错，因为windows上面，换行是`CR LF`（即\r\n）,而linux上面换行是`LF`(即\n)。通过这个命令可以把文本里所有CR LF替换成LF。因为修改了文件，所以需要:w保存一下。

4. :set list    显示特殊符号，

   用“$”表示的换行（\r\n或\n）

   用“^I”表示tab（^I,这里是一个大写的i，而非L或数字1）。

   用“^M”表示CR。当文件是纯dos的，即所有回车都是CR LF时，只显示$,不显示^M。

   总之，编译提如果提示有^M，就表示你需要把CR符号替换掉。

## 执行shell

在vi里面需要临时退出外面执行shell命令。用“:sh”命令即可。

比如，我修改了一个文件，然后发现没有修改权限：

```text
//vi a.txt
aaaaaa
bbbbb
ccccc
ddddd
~                                                                                                                                                                
~                                                                                                                                                                
~                                                                                                                                                               
E45: 已设定选项 'readonly' (请加 ! 强制执行) 
```

如果不保存退出，后面我就需要重新修改一次。所以我用:sh临时回到shell：

```shell
aaaaaa
bbbbb
ccccc
ddddd
~                                                                                                                                                                
~                                                                                                                                                                
~                                                                                                                                                             
:sh
```
回到shell后是这样：
```shell
work@ubuntu-cts:~/testVi$ vi a.txt 

[已修改但尚未保存]
work@ubuntu-cts:~/testVi$
```

然后我用chmod该权限。改好后，用exit或ctrl+d回到vi：

```shell
work@ubuntu-cts:~/testVi$ vi a.txt 

[已修改但尚未保存]
work@ubuntu-cts:~/testVi$ sudo chmod a+w testVi2.txt 
work@ubuntu-cts:~/testVi$ exit

# 这是下方出现一个警告：
W12: 警告: 文件 "a.txt" 已变动，并且在 Vim 中的缓冲区也已变动
进一步说明请见 ":help W12"
确定([O]), 加载文件((L)): 
```

输入O。如果输入L，会重新加载文件，你前面的修改会丢失。

然后保存。用“:wq”保存仍然会提示没有权限 “E45: 已设定选项 'readonly' (请加 ! 强制执行)”。

我们后面加一个感叹号，强制执行。因为权限已经改了，强制执行会成功。

## 多窗口

1. 先使用 vi打开第一个文件，接着输入命 令 ":sp file" 水平切分窗口，然后按回车键；
2. 如果想垂直切分窗口则可以输入 ":vs file";
3. 切换到另一个文件窗口，可以按 "Ctrl+ww" 

## vimdiff

一，

vimdiff 实际上是 Vim 编辑器的 diff 模式, 通过vimdiff FILE_LEFT FILE_RIGHT` 或者 `vi -d FILE_LEFT FILE_RIGHT或者vim -d FILE_LEFT FILE_RIGHT进入。

按 "Ctrl+ww" 在左右窗口切换。

二，

如果已经以split方式打开了两个文件file1，file2，又想比较两文件的不同。
分别在两个窗口里面输入命令：
:diffthis

三，

如果更改了某个窗口的内容，vim又没有自动更新diff检查，可以使用如下命令更新：
:diffupdate

四，

定位到不同点：
[c   跳到前一个不同点
]c   跳到后一个不同点

五，

光标移动到有差异的行，然后

dp     将光标当前行应用到另一文档（等效于`:diffput`命令）
do     光标当前行，把另一文档的内容拷贝到当前文档（等效于`:diffget`）

六，

折叠和展开

zo     (等价于:foldopen, z这个字母看上去比较像折叠的纸）

zc     (等价于:foldclose)

折叠后，两边相同的部分被折叠，只显示差异点。

六，

:q只退出光标所在文件，如果要两边一起退出加一个a（all的意思）。

qa        (未对文件做过修改，直接退出)
:qa!      (不保存文件退出)
:wqa    (保存文件并退出)



## 其它

1. shell里面有个history命令，vi也一样，用":history"查看历史命令。q退出。
2. shell里面用上下箭头切换前一个命令。vi一样，先输入冒号:，然后箭头。
3. shell里面用tab补全命令。vi一样。