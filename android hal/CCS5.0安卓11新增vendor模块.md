## CustomSetting模块

1. 在platform/vendor/hsae/hardware/interfaces目录下增加一个 CustomSetting 模块。代码结构如下：

   ```shell
   work@ubuntu-cts:~/ccs5.0/apps/LINUX/android/vendor/hsae/hardware/interfaces/CustomSetting$ tree
   .
   └── 1.0
       ├── Android.bp
       ├── default
       │   ├── Android.bp
       │   ├── HsaeFace.cpp
       │   ├── include
       │   │   ├── HsaeFace.h
       │   │   └── LogSwitch.h
       │   ├── proto
       │   │   ├── ipc_message_def.proto
       │   │   ├── user_face.proto
       │   │   └── user_key.proto
       │   ├── service.cpp
       │   └── vendor.hsae.hardware.custom_setting@1.0-service.rc
       ├── IHsaeFaceCallback.hal
       ├── IHsaeFace.hal
       └── types.hal
   
   4 directories, 13 files
   ```

   main函数代码如下：

   ```c++
   #include <hidl/HidlTransportSupport.h>
   #include "HsaeFace.h"
   #include "LogSwitch.h"
   
   using android::sp;
   
   using android::hardware::configureRpcThreadpool;
   using android::hardware::joinRpcThreadpool;
   
   using vendor::hsae::hardware::custom_setting::V1_0::IHsaeFace;
   using vendor::hsae::hardware::custom_setting::implementation::HsaeFace;
   
   using android::status_t;
   using android::OK;
   
   int main() {
       LOGI("main");
       android::sp<IHsaeFace> faceService = new HsaeFace();
   
       configureRpcThreadpool(4, true);
       status_t status = faceService->registerAsService();
   
       if (status == OK) {
           LOGI("HsaeFace HAL service Ready.");
           joinRpcThreadpool();
       }
   
       LOGE("Cannot register CustomSetting HAL service");
       return 1;
   }
   ```

   CustomSetting目录外面的Android.bp:

   ```
   subdirs = [
       "*"
   ]
   hidl_package_root {
       name: "vendor.hsae.hardware.early_autocore",
       path: "vendor/hsae/hardware/interfaces/early_autocore",
   }
   hidl_package_root {
       name: "vendor.hsae.hardware.metazone",
       path: "vendor/hsae/hardware/interfaces/metazone",
   }
   hidl_package_root {
        name: "vendor.hsae.hardware",
        path: "vendor/hsae/hardware/interfaces",
   }
   ```

   metazone和early_autocore是其它模块，不关心。

   `CustomSetting/1.0/Android.bp`：

   ```
   // This file is autogenerated by hidl-gen -Landroidbp.
   
   hidl_interface {
       name: "vendor.hsae.hardware.custom_setting@1.0",
       root: "vendor.hsae.hardware.custom_setting",
       srcs: [
           "types.hal",
           "IHsaeFace.hal",
           "IHsaeFaceCallback.hal",
       ],
       interfaces: [
           "android.hidl.base@1.0",
       ],
       gen_java: true,
   }
   ```

   `CustomSetting/1.0/default/Android.bp`：

   ```
   cc_binary {
       name: "vendor.hsae.hardware.custom_setting@1.0-service",
       defaults: ["hidl_defaults"],
       init_rc: ["vendor.hsae.hardware.custom_setting@1.0-service.rc"],
       relative_install_path: "hw",
       vendor: true,
   
       srcs: [
           "service.cpp",
           "HsaeFace.cpp",
           "proto/user_key.proto",
           "proto/user_face.proto",
           "proto/ipc_message_def.proto"
       ],
   
       shared_libs: [
           "liblog",
           "libhidlbase",
           "libhidltransport",
           "libutils",
           "libcutils",
           "libhardware",
           "libprotobuf-cpp-full",
           "vendor.hsae.hardware.custom_setting@1.0",
           "libutilscallstack",
       ],
   
       cflags: [
           "-Wno-unused-parameter",
           "-Wno-unused-variable",
           "-fexceptions",
       ],
   
       local_include_dirs : ["include"]
   }
   
   ```

   CustomSetting/1.0/default/vendor.hsae.hardware.custom_setting@1.0-service.rc：

   ```
   service custom_setting_hal_service /vendor/bin/hw/vendor.hsae.hardware.custom_setting@1.0-service
       class hal
       user root
       group root
   
   ```

   两个hal文件：

   IHsaeFace.hal

   ```
   package vendor.hsae.hardware.custom_setting@1.0;
   
   import IHsaeFaceCallback;
   
   interface IHsaeFace{
       setCallback(IHsaeFaceCallback callback);
       removeCallback();
       setUserId(int32_t userId);
       getUserId() generates (int32_t userId);
       setBindKeyNo(int32_t userId, vec<string> keyNo);
       getKeyNoByUserId(int32_t userId) generates (vec<string> keyNo);
       setBindFace(int32_t userId, string faceId);
       getFaceIdByUserId(int32_t userId) generates (string faceId);
       getBindFace() generates (vec<UserFace> userFaceMap);
       setFaceRecognitionExpiration(int32_t type);
       getFaceRecognitionExpiration() generates  (bool expired);
   };
   ```

   IHsaeFaceCallback.hal:

   ```
   package vendor.hsae.hardware.custom_setting@1.0;
   
   interface IHsaeFaceCallback {
       notifyFaceIdEnabled(int32_t status);
   };
   ```

2.  把目标文件添加到PRODUCT_PACKAGES变量

   8155平台：

   `vendor/qcom/msmnileau/msmnile_au.mk`

   ```makefile
   PRODUCT_PACKAGES += vendor.hsae.hardware.custom_setting@1.0-service
   ```

   6155平台：

   `device/qcom/sm6150_au/sm6150_au.mk`,同8155。

3. 暴露hidl接口

   `hardware/interfaces/compatibility_matrices/compatibility_matrix.5.xml`

   ```xml
       <hal format="hidl">
           <name>vendor.hsae.hardware.custom_setting</name>
           <version>1.0</version>
        <interface>
               <name>IHsaeFace</name>
            <instance>default</instance>
           </interface>
           <fqname>@1.0::IHsaeFace/default</fqname>
       </hal>
   ```
   
   `device/qcom/msmnile_au/manifest.xml`和`android/device/qcom/sm6150_au/manifest.xml`：
   
   ```xml
   <hal format="hidl">
       <name>vendor.hsae.hardware.custom_setting</name>
       <transport>hwbinder</transport>
       <version>1.0</version>
    <interface>
           <name>IHsaeFace</name>
        <instance>default</instance>
       </interface>
       <fqname>@1.0::IHsaeFace/default</fqname>
   </hal>
   ```
   
4. 添加selinux配置

   `system/sepolicy/vendor/file_contexts`:

   ```
   #CustomSetting
   /(vendor|system/vendor)/bin/hw/vendor\.hsae\.hardware\.custom_setting@1\.0-service u:object_r:hal_custom_setting_default_exec:s0
   ```

   在同目录下新建“**hal_custom_setting_default.te**”，内容：

   ```
   type hal_custom_setting_default, domain;
   #hal_server_domain(hal_custom_setting_default, hal_custom_setting)
   
   type hal_custom_setting_default_exec, exec_type, vendor_file_type, file_type;
   init_daemon_domain(hal_custom_setting_default)
   
   allow hal_custom_setting_default default_android_hwservice:hwservice_manager { find add };
   allow hal_custom_setting_default hidl_base_hwservice:hwservice_manager { add };
   allow hal_custom_setting_default hwservicemanager_prop:file { read open getattr map };
   allow hal_custom_setting_default hwservicemanager:binder { call transfer };
   ```

   关于allow这些内容怎么来的，先把系统设置我宽容模式，然后运行，log会打印“avc: denied”：

   ```txt
   
   07-05 14:42:22.731 19238 19238 I vendor.hsae.har: type=1400 audit(0.0:19532): avc: denied { read } for name="u:object_r:hwservicemanager_prop:s0" dev="tmpfs" ino=32579 scontext=u:r:hal_custom_setting_default:s0 tcontext=u:object_r:hwservicemanager_prop:s0 tclass=file permissive=1
   
   07-05 14:42:22.731 19238 19238 I vendor.hsae.har: type=1400 audit(0.0:19533): avc: denied { open } for path="/dev/__properties__/u:object_r:hwservicemanager_prop:s0" dev="tmpfs" ino=32579 scontext=u:r:hal_custom_setting_default:s0 tcontext=u:object_r:hwservicemanager_prop:s0 tclass=file permissive=1
   
   07-05 14:42:22.731 19238 19238 I vendor.hsae.har: type=1400 audit(0.0:19534): avc: denied { getattr } for path="/dev/__properties__/u:object_r:hwservicemanager_prop:s0" dev="tmpfs" ino=32579 scontext=u:r:hal_custom_setting_default:s0 tcontext=u:object_r:hwservicemanager_prop:s0 tclass=file permissive=1
   
   07-05 14:42:22.731 19238 19238 I vendor.hsae.har: type=1400 audit(0.0:19535): avc: denied { map } for path="/dev/__properties__/u:object_r:hwservicemanager_prop:s0" dev="tmpfs" ino=32579 scontext=u:r:hal_custom_setting_default:s0 tcontext=u:object_r:hwservicemanager_prop:s0 tclass=file permissive=1
   
   07-05 14:42:22.731 19238 19238 I vendor.hsae.har: type=1400 audit(0.0:19536): avc: denied { call } for scontext=u:r:hal_custom_setting_default:s0 tcontext=u:r:hwservicemanager:s0 tclass=binder permissive=1
   07-05 14:42:22.731 19238 19238 I vendor.hsae.har: type=1400 audit(0.0:19537): avc: denied { transfer } for scontext=u:r:hal_custom_setting_default:s0 tcontext=u:r:hwservicemanager:s0 tclass=binder permissive=1
   ```

   根据日志，添加allow。格式是：`allow scontext tcontext：class 权限`

## early_autocore模块

   参见“CCS5.0 增加hidl程序的编译.txt”。

## arcface模块

arcface是虹软提供的，包含java framework层、hal层、native层的完整代码。现只关注hal层结构和selinux的配置。

`vendor/hsae/hardware/interfaces/arcface`结构:

```shell
.
└── 1.0
    ├── Android.bp
    ├── default
    │   ├── Android.bp
    │   ├── ArcFace.cpp
    │   ├── ArcFace.h
    │   ├── service.cpp
    │   └── vendor.hsae.hardware.arcface@1.0-service.rc
    ├── IArcFaceClientCallback.hal
    ├── IArcFace.hal
    ├── test
    │   ├── Android.bp
    │   └── hal_arcface_test.cpp
    └── types.hal

3 directories, 11 files
```

编译后，可执行程序“vendor.hsae.hardware.arcface@1.0-service”拷贝到“/vendor/bin/hw/”目录，动态库“vendor.hsae.hardware.arcface@1.0”拷贝到`/vendor/lib64`，rc文件会拷贝到：`/vendor/etc/init/`路径。

`vendor/hsae/proprietary/arcfacehal`的结构：

```shell
.
├── Android.mk
├── inc
│   ├── AISFCommonDef.h
│   ├── AISFReferenceInter.h
│   ├── amcomdef.h
│   ├── ammem.h
│   ├── arcsoft_faceidmanager_def.h
│   ├── asvloffscreen.h
│   ├── FaceIdErrorCode.h
│   ├── FaceIdStub.h
│   ├── FaceIdStubReturnListener.h
│   ├── FILog.h
│   └── merror.h
└── src
    ├── arcfacehal.cpp
    └── FaceIdStubReturnListener.cpp

2 directories, 14 files
```

编译输出“arcfacehal”共享库，这里面实现hal层设备“arcface_device_t”的实现逻辑。“vendor.hsae.hardware.arcface@1.0-service”加载这个库，调用库的实现方法。

`arcfacehal`通过socket与`fi-server`通信。“vendor/hsae/proprietary/fi-server”：

```shell
.
├── Android.mk
├── inc
│   ├── AISFCommonDef.h
│   ├── AISFReferenceInter.h
│   ├── amcomdef.h
│   ├── ammem.h
│   ├── asvloffscreen.h
│   ├── FILog.h
│   ├── IRealCamera.h
│   ├── IServer.h
│   └── merror.h
├── inner_inc
│   ├── arcsoft_faceidmanager_def.h
│   ├── arcsoft_faceidmanager.h
│   ├── qcarcam.h
│   └── qcarcam_types.h
└── service
    ├── main.cpp
    └── main.h

3 directories, 16 files
```



`fi-server`是真正实现核心业务功能的地方，包含了虹软的核心算法实现，这部分是虹软的专利，不会给我们。因此也是以库的形式提供。目录在：

vendor/qcom/proprietary/prebuilt_HY11/target/product

```shell
.
└── msmnile_au
    ├── obj
    │   └── STATIC_LIBRARIES
    │       ├── libficlient.arcsoft_intermediates
    │       │   └── libficlient.arcsoft.a
    │       └── libfiserver.arcsoft_intermediates
    │           └── libfiserver.arcsoft.a
    └── vendor
        └── lib64
            ├── libarcsoft_faceid.so
            ├── libfaceid_manager.arcsoft.so
            └── libmpbase.so
 
```

sm6150_au目录下不需要在放一份，而是在6150下的Android.mk里直接指向msmnile_au。mk内容类似（以libfaceid_manager.arcsoft.so为例）:

```makefile
include $(CLEAR_VARS)
LOCAL_MODULE        := libfaceid_manager.arcsoft
LOCAL_MODULE_CLASS  := SHARED_LIBRARIES
LOCAL_MODULE_SUFFIX := .so
LOCAL_STRIP_MODULE  := false
LOCAL_MULTILIB      := 64
LOCAL_MODULE_OWNER  := qcom
LOCAL_MODULE_TAGS   := optional
LOCAL_SRC_FILES     := ../../.././target/product/msmnile_au/vendor/lib64/libfaceid_manager.arcsoft.so
LOCAL_MODULE_PATH   := $(PRODUCT_OUT)/$(TARGET_COPY_OUT_VENDOR)/lib64
LOCAL_PROPRIETARY_MODULE := true
include $(BUILD_PREBUILT)
```

以上是代码的文件结构目录。其它配置项包括：

`vendor/qcom/proprietary/common/config/device-vendor.mk`里添加

```makefile
 # ARCFACEHAL
ARCFACEHAL := arcfacehal.default
# ARCFACEHALTEST
ARCFACEHALTEST := hal_arcface_test 
# FISERVERD
FISERVERD := fiserverd 
FISERVERD += libarcsoft_faceid
FISERVERD += libfaceid_manager.arcsoft
FISERVERD += libmpbase

PRODUCT_PACKAGES += $(ARCFACEHAL)
PRODUCT_PACKAGES += $(ARCFACEHALTEST)
PRODUCT_PACKAGES += $(FISERVERD)
```

`device/qcom/msmnile_au/init.target.rc`添加fiserverd的开机启动：

```
on boot
    start vendor.fiserverd

#add fiserverd
service vendor.fiserverd /vendor/bin/fiserverd
    user system
    group camera input graphics system
    disabled
```

`device/qcom/msmnile_au/manifest.xml`配置hidl接口，sm6150_au目录一样：

```xml
    <hal format="hidl">
        <name>vendor.hsae.hardware.arcface</name>
        <transport>hwbinder</transport>
        <version>1.0</version>
        <interface>
            <name>IArcFace</name>
            <instance>default</instance>
        </interface>
    </hal>
```

`hardware/interfaces/compatibility_matrices/compatibility_matrix.5.xml`:

```xml
<hal format="hidl" optional="true">
    <name>vendor.hsae.hardware.arcface</name>
    <version>1.0</version>
    <interface>
        <name>IArcFace</name>
        <instance>default</instance>
    </interface>
</hal>
```



`device/qcom/msmnile_au/msmnile_au.xml`在PRODUCT_PACKAGES变量上添加文件：

```makefile
PRODUCT_PACKAGES += 	vendor.hsae.hardware.arcface@1.0-service
```

然后selinux：

`device/qcom/sepolicy_vndr/generic/vendor/common/file_contexts`:

```
/vendor/bin/fiserverd           u:object_r:vendor_fiserverd_exec:s0
```

`device/qcom/sepolicy_vndr/generic/vendor/common/fiserverd.te`:

```
type vendor_fiserverd, domain;

type vendor_fiserverd_exec, exec_type, vendor_file_type, file_type;
init_daemon_domain(vendor_fiserverd);

allow vendor_fiserverd port:tcp_socket name_bind;
allow vendor_fiserverd node:tcp_socket node_bind;
allow vendor_fiserverd self:tcp_socket {create bind accept listen read write setopt getopt connect };
allow vendor_fiserverd port:tcp_socket name_connect;
allow vendor_fiserverd video_device:chr_file rw_file_perms;

allow vendor_fiserverd vendor_camera_data_file:dir w_dir_perms;
allow vendor_fiserverd vendor_camera_data_file:sock_file create_file_perms;
allow vendor_fiserverd video_device:chr_file rw_file_perms;
allow vendor_fiserverd ion_device:chr_file r_file_perms;
allow vendor_fiserverd vendor_camera_data_file:file { create write open getattr read };
allow vendor_fiserverd tee_device:chr_file { ioctl open read write };
allow vendor_fiserverd vendor_camera_data_file:file { lock unlink append };
allow vendor_fiserverd self:netlink_route_socket { create write nlmsg_read read };
allow vendor_fiserverd self:udp_socket { create bind setattr connect write read listen getopt };
allow vendor_fiserverd port:udp_socket name_bind;
allow vendor_fiserverd node:udp_socket node_bind;
allow vendor_fiserverd vendor_camera_data_file:dir read;
```

`device/qcom/sepolicy_vndr/generic/vendor/common/hal_arcface_default.te`文件内容：

```
vndbinder_use(hal_arcface_default);
typeattribute hal_arcface_default hal_automotive_socket_exemption;

allow hal_arcface_default vendor_camera_data_file:dir {search write add_name remove_name};
allow hal_arcface_default vendor_camera_data_file:file { create write open getattr read };
allow hal_arcface_default vendor_camera_data_file:sock_file { create unlink write read open};
allow hal_arcface_default vendor_fiserverd:unix_stream_socket connectto;

allow hal_arcface_default port:tcp_socket name_bind;
allow hal_arcface_default node:tcp_socket node_bind;
allow hal_arcface_default self:tcp_socket {create bind accept listen read write};
```

`system/sepolicy/vendor/file_contexts`:

```
#ARCFACE
/(vendor|system/vendor)/bin/hw/vendor\.hsae\.hardware\.arcface@1\.0-service u:object_r:hal_arcface_default_exec:s0
```

`system/sepolicy/vendor/hal_arcface_default.te`:

```
type hal_arcface_default, domain;
hal_server_domain(hal_arcface_default, hal_arcface)

type hal_arcface_default_exec, exec_type, vendor_file_type, file_type;
init_daemon_domain(hal_arcface_default)
```



还有涉及framework层的selinux相关配置，一时也分不清哪些是给上层的，一起贴上

`system/sepolicy/prebuilts/api/30.0/private/app_neverallows.te`

```
neverallow all_untrusted_apps {
  hal_arcface_hwservice
}:hwservice_manager find;
```

`system/sepolicy/prebuilts/api/30.0/private/compat/26.0/26.0.ignore.cil`

```
在(typeattributeset new_objects这里
添加：
arcfaceid_service
hal_arcface_hwservice
```

compat/27.0/27.0.ignore.cil、compat/28.0/28.0.ignore.cil、compat/28.0/28.0.ignore.cil、29、30等同理，都加一下。

然后`system/sepolicy/prebuilts/api/30.0/private/hwservice_contexts`添加一行

```
vendor.hsae.hardware.arcface::IArcFace               	        u:object_r:hal_arcface_hwservice:s0
```

`system/sepolicy/prebuilts/api/30.0/private/service_contexts`添加一行

```
arcfaceid                                 u:object_r:arcfaceid_service:s0
```

`system/sepolicy/prebuilts/api/30.0/private/system_server.te`添加

```
hal_client_domain(system_server, hal_arcface)
```

`system/sepolicy/prebuilts/api/30.0/public/attributes`添加

```
hal_attribute(arcface);
```

`system/sepolicy/prebuilts/api/30.0/public/hal_arcface.te`新建文件添加

```
# HwBinder IPC from client to server, and callbacks
binder_call(hal_arcface_client, hal_arcface_server)
binder_call(hal_arcface_server, hal_arcface_client)

hal_attribute_hwservice(hal_arcface, hal_arcface_hwservice)
```

`system/sepolicy/prebuilts/api/30.0/public/hwservice.te`添加

```
type hal_arcface_hwservice, hwservice_manager_type;
```

`system/sepolicy/prebuilts/api/30.0/public/service.te`添加

```
type arcfaceid_service, app_api_service, system_server_service, service_manager_type;
```

`system/sepolicy/prebuilts/api/30.0/public/su.te`添加

```
typeattribute su hal_arcface_client;
放到userdebug_or_eng里面
```

`system/sepolicy/private/app_neverallows.te`添加

```
neverallow all_untrusted_apps {
  hal_arcface_hwservice
}:hwservice_manager find;
```

`system/sepolicy/private/compat/26.0/26.0.ignore.cil`添加

```
在(typeattributeset new_objects这里
添加：
arcfaceid_service
hal_arcface_hwservice
```

主要要和上面那个`system/sepolicy/prebuilts/api/30.0/private/compat/26.0/26.0.ignore.cil`完全一样，包括放的位置都要一样。否则编译报错。然后compat里的27、28、29等版本都加一下。

`system/sepolicy/private/hwservice_contexts`添加：

```
vendor.hsae.hardware.arcface::IArcFace               	        u:object_r:hal_arcface_hwservice:s0
```

`system/sepolicy/private/service_contexts`添加：

```
arcfaceid                                 u:object_r:arcfaceid_service:s0
```

`system/sepolicy/private/system_server.te`添加：

```
hal_client_domain(system_server, hal_arcface)
```

`system/sepolicy/public/attributes`添加：

```
hal_attribute(arcface);
```

`system/sepolicy/public/hal_arcface.te`新建文件添加：

```
# HwBinder IPC from client to server, and callbacks
binder_call(hal_arcface_client, hal_arcface_server)
binder_call(hal_arcface_server, hal_arcface_client)

hal_attribute_hwservice(hal_arcface, hal_arcface_hwservice)
```

`system/sepolicy/public/hwservice.te`添加：

```
type hal_arcface_hwservice, hwservice_manager_type;
```

`system/sepolicy/public/service.te`添加：

```
type arcfaceid_service, app_api_service, system_server_service, service_manager_type;
```

`system/sepolicy/public/su.te`添加：

```
typeattribute su hal_arcface_client;
```

一个selinux改了这么多文件！什么叫专业啊！！